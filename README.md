# HapticDev-FW
Firmware for STM32F407 DISCO1 used in a haptic device. The firmware depends on STM32 HAL Library.


### GPIO PINI: 

GPIOC: 
- PIN8 : motor pulse generated by TIM3/Channel OC mode

GPIOE:
- PIN7 : direction 
- PIN8 : enable
- PIN9 : M0
- PIN11 : M1
- PIN13 : M2

### main.h
defines ACCELERATION and MICROSTEP constants in order to select appropriate acceleration and microstepping. Also defines various other constats related to the motor and the haptic device

```C
// GPIO Related constants:
#define nENABLE_PIN 		  GPIO_PIN_8
#define DIRECTION_PIN 		GPIO_PIN_7
#define M0_PIN 				    GPIO_PIN_9
#define M1_PIN 				    GPIO_PIN_11
#define M2_PIN 				    GPIO_PIN_13
```

```C
// Microstepping defs:
#define MICROSTEP_1		1 // DO NOT USE!!! MOTOR CANNOT RUN AT LOW SPEEDS
#define MICROSTEP_2		2
#define MICROSTEP_4		4
#define MICROSTEP_8		8
#define MICROSTEP_16	16
#define MICROSTEP_32	32
#define MICROSTEPS      MICROSTEP_32
```

```C
// Acceleration and motor related constants defs:
// Motor related constants
#define CRANKSHAFTDIAMETER  30        // diameter in mm
// Acceleration in mm/s. Should be one of the values: 100,200,250,500,1000
#define ACCELERATION_100        100.0     // acceleration in mm/s2
#define ACCELERATION_200        200.0     // acceleration in mm/s2
#define ACCELERATION_250        250.0     // acceleration in mm/s2
#define ACCELERATION_500        500.0     // acceleration in mm/s2
#define ACCELERATION_1000       1000.0    // acceleration in mm/s2
#define ACCELERATION ACCELERATION_500

// Set the delay so that the delta_speed is always 1ms and delta frerqency is always 68:
#define DELTA_T 			UINT_ROUND((1000.0 / ACCELERATION))
#define DELTA_SPEED         (ACCELERATION * DELTA_T) / 1000
#define MOTORSTEPS          200
#define PI                  3.14159265359
#define DELTAFREQ           DELTA_SPEED / ( (CRANKSHAFTDIAMETER*PI) / (MOTORSTEPS*MICROSTEPS) )
```



### timer.c
Init functions and callbacks for Timer 3. Timer 3 is initialized and started in OC interrupt mode (*HAL_StatusTypeDef Init_TIM3_OC(TIM_HandleTypeDef\* TIMHandle)*). It toggles GPIOC PIN8. 
The callback function *HAL_TIM_OC_DelayElapsedCallback(TIM_HandleTypeDef\* htim)* is called from timer interrupt handler and updates CCR register for channel 3.

### stm32f7xx_hal_msp_tim.c
It implements low-level timer init functions. *void HAL_TIM_OC_MspInit(TIM_HandleTypeDef \*htim)* is used to initialize GPIOC PIN8, driven bt TIM3/Ch3, and interrupt controller.

### GPIO.c
GPIOE initialization (used to drive several 8825 - MOTOR DRIVER pins) and microstepping selection

### UART.c
UART Init and callbacks. \
*void USART_Init(UART_HandleTypeDef\* pUartHandle)* initializes the selected UART, \
*HAL_UART_TxCpltCallback()* and *HAL_UART_RxCpltCallback()* are callbacks called from the UART handler upon succesful UART transmission/reception. 
Callbacks use booleans *UartTXReady* and *UartRXReady* to signal TX/RX completion

### stm32f7xx_hal_msp_uart.c
Low level UART initialization. The function *void HAL_UART_MspInit(UART_HandleTypeDef \*huart)* sets GPIO pins used for TX/RX, and enables GPIO and USART clocks.

### stm32f4xx_hal_timebase_tim.c 
sets the 1ms timebase using TIM6

### stm32f4xx_hal_timebase_tim.c 
STM32F4xx Peripherals Interrupt Handlers 

### main.c
1. init all peripherals
2. receives new speed over UART and sets a new TIM3 CCR period according to the speed. 
3. *static void ChangeSpeed(void)*:
   - speed is changed in several steps according to the selected acceleration
   - delta speed in one step is always 1mm/s
   - delta time = delta speed / a (e.g., if a = 500 mm/s2, delta time = 1 /500 = 2ms)
   - delta freqency = delta speed / K, where K = (cranck shaft diameter * PI) / (motor steps * micro steps)
   - new CCR frequency = current CCR frequency + delta frequency
   - new CCR period = 1 / new CCR frequency
